name: Data Pipeline CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pre-commit

      # Mock environment prevents import-time crashes in assets.py
      # dbt profiles dir must exist before DbtProject initialization
      - name: Create mock environment
        run: |
          touch .env
          echo "GCP_PROJECT_ID=ci_test_project" >> .env
          echo "DBT_KEY_PATH=/tmp/dummy_key.json" >> .env
          echo "BQ_DATASET_ID=ci_test_dataset" >> .env
          echo "BQ_TABLE_ID=ci_test_table" >> .env
          echo "CSV_PATH=data/raw/creditcard.csv" >> .env
          echo "DBT_PROJECT_DIR=./dbt_project" >> .env
          echo "DAGSTER_POSTGRES_HOST=localhost" >> .env
          echo "POSTGRES_USER=test_user" >> .env
          echo "POSTGRES_PASSWORD=test_pass" >> .env
          echo "POSTGRES_DB=test_db" >> .env

          echo '{"type": "service_account"}' > /tmp/dummy_key.json

          mkdir -p ~/.dbt
          cat <<EOF > ~/.dbt/profiles.yml
          credit_card_analytics:
            target: dev
            outputs:
              dev:
                type: bigquery
                method: service-account
                project: ci_dummy_project
                dataset: ci_dummy_dataset
                threads: 1
                keyfile: /tmp/dummy_key.json
                location: asia-southeast1
                priority: interactive
          EOF

      - name: Run linting
        run: pre-commit run --all-files

      - name: Run unit tests
        run: pytest dagster_project/tests/ -v

      # Validates SQL syntax without BigQuery connection
      - name: Validate dbt models
        run: |
          cd dbt_project
          dbt deps
          dbt parse
