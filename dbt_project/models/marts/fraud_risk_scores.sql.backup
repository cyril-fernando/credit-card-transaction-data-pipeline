/*
    Fraud risk scoring with incremental loading.
    Processes only new transactions since last run to optimize cost and performance.
*/

{{
    config(
        materialized='incremental',
        unique_key='transaction_id',
        partition_by={
            'field': 'transaction_date',
            'data_type': 'date',
            'granularity': 'day'
        },
        cluster_by=['is_fraud', 'hour_of_day'],
        incremental_strategy='merge',
        on_schema_change='append_new_columns'
    )
}}

WITH source AS (
    SELECT
        transaction_id,
        transaction_timestamp,
        transaction_date,
        amount,
        is_fraud,
        hour_of_day,
        day_of_week,
        amount_z,
        amount_log
    FROM {{ ref('int_transaction_features') }}
    
    {% if is_incremental() %}
        WHERE transaction_date > (SELECT MAX(transaction_date) FROM {{ this }})
    {% endif %}
),

risk_categorization AS (
    SELECT
        *,
        CASE
            WHEN amount_z >= 2.0 THEN 'High'
            WHEN amount_z >= 1.0 THEN 'Medium'
            ELSE 'Low'
        END AS amount_risk_category
    FROM source
)

SELECT * FROM risk_categorization
